var Y=Object.defineProperty;var F=(n,e,t)=>e in n?Y(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var M=(n,e,t)=>(F(n,typeof e!="symbol"?e+"":e,t),t);import{r as m,j as z}from"./index-Bi1sFTVc.js";import{C as G}from"./CCol-D9bs_7sE.js";const N=Object.freeze({x:0,y:0,untransformedX:0,untransformedY:0}),A=Object.freeze({canvasWidth:0,canvasHeight:0,left:0,top:0,right:0,bottom:0,viewMin:N,viewMax:N}),b=Object.freeze({a:1,b:0,c:0,d:1,e:0,f:0});class H{constructor(e,t){M(this,"_canvas",null);M(this,"_view",{scale:1,x:0,y:0});M(this,"_viewChangeListeners",new Set);this._scaleExtents=e,this._documentSize=t}get canvas(){return this._canvas}set canvas(e){this._canvas=e,this.setView()}get scale(){return this._view.scale}setScale(e){this.setView({scale:e})}get x(){return this._view.x}set x(e){this.setView({x:e})}get y(){return this._view.y}set y(e){this.setView({y:e})}get view(){return{...this._view}}get scaleExtents(){return{...this._scaleExtents}}set scaleExtents(e){this._scaleExtents={...e},this.setView()}get documentSize(){return{...this._documentSize}}set documentSize(e){this._documentSize={...e},this.setView()}get transformMatrix(){return{a:this._view.scale,b:0,c:0,d:this._view.scale,e:this._view.x,f:this._view.y}}get canvasBounds(){if(this._canvas){const{left:e,top:t,right:i,bottom:s}=this._canvas.getBoundingClientRect();return{viewMin:this.clientPointToViewPoint({clientX:e,clientY:t}),viewMax:this.clientPointToViewPoint({clientX:i,clientY:s}),left:e,top:t,right:i,bottom:s,canvasWidth:this._canvas.width,canvasHeight:this._canvas.height}}else return}get canvasRect(){if(this._canvas)return this._canvas.getBoundingClientRect()}clampView(e){const{min:t,max:i}=this._scaleExtents,{width:s,height:c}=this._documentSize,{left:r,top:d,right:h,bottom:l}=this.canvasRect||A,a=h-r,g=l-d,v=a/2,p=-(s*this._view.scale-a/2),R=g/2,u=-(c*this._view.scale-g/2);return{scale:Math.min(Math.max(e.scale,t),i),x:Math.min(Math.max(e.x,p),v),y:Math.min(Math.max(e.y,u),R)}}resetView(){this.setView({scale:1,x:0,y:0})}setView(e){const t=this.clampView({...this._view,...e||{}}),{scale:i,x:s,y:c}=this._view;return(t.scale!==i||t.x!==s||t.y!==c)&&(this._view=t,this._viewChangeListeners.forEach(r=>r&&r({view:t,transform:this.transformMatrix}))),{...this._view}}scaleAtClientPoint(e,t){const i=this.clientPointToViewPoint(t),s=this.clampView({...this._view,scale:this._view.scale+e}),c=this.viewPointToClientPoint(i,s);return s.x=this._view.x-(c.clientX-t.clientX),s.y=this._view.y-(c.clientY-t.clientY),this.setView(s)}clientPointToViewPoint(e,t=this._view){const{left:i,top:s}=this.canvasRect||A,c=e.clientX-i,r=e.clientY-s;return{x:(c-t.x)/t.scale,y:(r-t.y)/t.scale,relativeClientX:c,relativeClientY:r}}viewPointToClientPoint(e,t=this._view){const{left:i,top:s}=this.canvasRect||A,c=e.x*t.scale+t.x,r=e.y*t.scale+t.y,d=c+i,h=r+s;return{clientX:d,clientY:h,relativeX:c,relativeY:r,x:d,y:h}}attachViewChangeListener(e){this._viewChangeListeners.add(e)}}const X=(n,e,t)=>{n.width=e,n.height=t,n.style.width=`${e}px`,n.style.height=`${t}px`},K=(n,e)=>{for(const t in n)Object.prototype.hasOwnProperty.call(n,t)&&X(n[t],e.width,e.height)};function $({ctx:n,image:e,x:t=0,y:i=0,w:s=n.canvas.width,h:c=n.canvas.height,offsetX:r=.5,offsetY:d=.5}){r<0&&(r=0),d<0&&(d=0),r>1&&(r=1),d>1&&(d=1);const h=e.width,l=e.height,a=Math.min(s/h,c/l);let g=h*a,v=l*a,p,R,u,y,x=1;g<s&&(x=s/g),Math.abs(x-1)<1e-14&&v<c&&(x=c/v),g*=x,v*=x,u=h/(g/s),y=l/(v/c),p=(h-u)*r,R=(l-y)*d,p<0&&(p=0),R<0&&(R=0),u>h&&(u=h),y>l&&(y=l),n.drawImage(e,p,R,u,y,t,i,s,c)}function J({canvas:n,ctx:e,image:t}){if(t&&t.complete&&n&&e){const i=t.width,s=t.height,c=n.getBoundingClientRect(),r=c.width,d=c.height,h=i/s;let l=r,a=l/h;a>d&&(a=d,l=a*h),e.drawImage(t,0,0,i,s,0,0,l,a)}}function q({canvas:n,ctx:e,image:t}){if(t&&t.complete&&n&&e){const i=t.width,s=t.height,c=n.getBoundingClientRect(),r=c.width,d=c.height;e.drawImage(t,0,0,i,s,0,0,r,d)}}function Q(n=()=>{}){const e=m.useRef(!1);e.current||(n(),e.current=!0)}function Z(n,e="default"){Q(()=>{console.log("useInteractionState constructor")});const t=m.useRef({isPressing:!1}),i=m.useCallback(r=>{switch(r){case"default":default:return new V(n,t.current)}},[n.context]),[s,c]=m.useState(i(e));return m.useEffect(()=>{const r=n.canvas;if(!r)return;const d=g=>{t.current.isPressing=!0,s.handleMouseDown(g)},h=g=>{s.handleMouseMove(g)},l=g=>{t.current.isPressing=!1,s.handleMouseUp(g)},a=g=>{g.shiftKey&&s.handleMouseWheel(g)};return r.addEventListener("mousedown",d),r.addEventListener("mousemove",h),r.addEventListener("mouseup",l),r.addEventListener("wheel",a),()=>{r.removeEventListener("mousedown",d),r.removeEventListener("mousemove",h),r.removeEventListener("mouseup",l),r.removeEventListener("wheel",a)}},[n.canvas,s]),m.useEffect(()=>{switch(e){case"default":c(new V(n,t.current));break}},[n.context]),s}class ee{constructor(e,t){M(this,"resizePoint");this.props=e,this.interactionRef=t,this.handleMouseWheel=this.handleMouseWheel.bind(this),this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this)}handleMouseWheel(e){}handleMouseDown(e){}handleMouseMove(e){}handleMouseUp(e){}}class V extends ee{constructor(e,t){super(e,t)}handleMouseWheel(e){e.shiftKey&&this.props.coordinateSystem.scaleAtClientPoint(-.001*e.deltaY,{clientX:e.clientX,clientY:e.clientY})}handleMouseDown(e){e.preventDefault();const{canvas:t,context:i,rectangles:s,coordinateSystem:c}=this.props;if(!t||!i||!c)return;const{top:r,left:d}=c.canvas.getBoundingClientRect(),h=e.clientX-d,l=e.clientY-r,a=s.isAnyAtPoint(h,l);a?s.isSelected(a.id)||(s.selected=[a]):(this.resizePoint=s.isNearAnyResizePoint(h,l),this.resizePoint||(s.selected=[])),i.clearRect(0,0,t.width,t.height),s.draw(i)}handleMouseMove(e){e.preventDefault();const{canvas:t,context:i,rectangles:s,coordinateSystem:c}=this.props;if(!t||!c)return;const r={x:e.movementX,y:e.movementY};this.interactionRef.isPressing&&(this.resizePoint?s.resizeSelected(this.resizePoint.key,r):s.moveSelected(r),i.clearRect(0,0,t.width,t.height),s.draw(i))}handleMouseUp(e){this.resizePoint=void 0;const{rectangles:t}=this.props;t.processDisplacement()}}function te(){const[n,e]=m.useState({width:window.innerWidth,height:window.innerHeight}),t=()=>{e({width:window.innerWidth,height:window.innerHeight})};return m.useEffect(()=>(window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)),[]),n}const se="#ffff66",ie=(n,e)=>{const t=n.slice(1),i=parseInt(t,16),s=i>>16&255,c=i>>8&255,r=i&255;return`rgba(${s}, ${c}, ${r}, ${e})`},ne=n=>/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)$/i.test(n);function ce(n){return"exportData"in n}class re{constructor(e,t){this.id=e,this.color=ne(t)?t:ie(t,.6)}}class O extends re{constructor(e,t,i,s,c,r){super(e,t),this.x=i,this.y=s,this.width=c,this.height=r}drag(e){this.x+=e.x,this.y+=e.y}draw(e){e.fillStyle=this.color,e.fillRect(this.x,this.y,this.width,this.height)}contains(e,t){return e>=this.x&&e<=this.x+this.width&&t>=this.y&&t<=this.y+this.height}resize(e,t){switch(e){case"nw-resize":this.width-=t.x,this.height-=t.y,this.x+=t.x,this.y+=t.y;break;case"n-resize":this.height-=t.y,this.y+=t.y;break;case"ne-resize":this.width+=t.x,this.height-=t.y,this.y+=t.y;break;case"w-resize":this.width-=t.x,this.x+=t.x;break;case"e-resize":this.width+=t.x;break;case"sw-resize":this.width-=t.x,this.height+=t.y,this.x+=t.x;break;case"s-resize":this.height+=t.y;break;case"se-resize":this.width+=t.x,this.height+=t.y;break}}}class oe{constructor(e=[]){M(this,"_selected",[]);this._rectangles=e}get rectangles(){return this._rectangles}set rectangles(e){this._rectangles=e}get minx(){if(this.selected.length!==0)return Math.min(...this.selected.map(e=>this.get(e.id).x))}get miny(){if(this.selected.length!==0)return Math.min(...this.selected.map(e=>this.get(e.id).y))}get maxx(){if(this.selected.length!==0)return Math.max(...this.selected.map(e=>this.get(e.id).x+this.get(e.id).width))}get maxy(){if(this.selected.length!==0)return Math.max(...this.selected.map(e=>this.get(e.id).y+this.get(e.id).height))}get resizePoints(){if(this.selected.length===0)return[];const e=this.minx,t=this.miny,i=this.maxx,s=this.maxy;return[{key:"nw-resize",pos:{x:e,y:t}},{key:"n-resize",pos:{x:e+(i-e)/2,y:t}},{key:"ne-resize",pos:{x:i,y:t}},{key:"w-resize",pos:{x:e,y:t+(s-t)/2}},{key:"e-resize",pos:{x:i,y:t+(s-t)/2}},{key:"sw-resize",pos:{x:e,y:s}},{key:"s-resize",pos:{x:e+(i-e)/2,y:s}},{key:"se-resize",pos:{x:i,y:s}}]}get selected(){return this._selected}set selected(e){this._selected=e}add(e){this.rectangles.push(e)}remove(e){this.rectangles=this.rectangles.filter(t=>t.id!==e)}draw(e){this.drawRectangles(e),this.drawSelection(e),this.drawResizePoints(e)}drawRectangles(e){this.rectangles.forEach(t=>{e.fillStyle=t.color,e.fillRect(t.x,t.y,t.width,t.height)})}drawSelection(e){if(this.selected.length===0)return;const t=this.minx,i=this.miny,s=this.maxx,c=this.maxy;e.strokeStyle="black",e.lineWidth=1,e.setLineDash([5,3]),e.strokeRect(t,i,s-t,c-i)}drawResizePoints(e){if(this.selected.length===0)return;const t=5,i=t/2,s=this.resizePoints;e.fillStyle="black",s.forEach(c=>{e.fillRect(c.pos.x-i,c.pos.y-i,t,t)})}isNearAnyResizePoint(e,t){return this.resizePoints.find(i=>e>=i.pos.x-5&&e<=i.pos.x+5&&t>=i.pos.y-5&&t<=i.pos.y+5)}isAnyAtPoint(e,t){return this.rectangles.find(i=>i.contains(e,t))}clear(){this._rectangles=[],this._selected=[]}clearSelection(){this._selected=[]}isSelected(e){return this.selected.some(t=>t.id===e)}get(e){return this.rectangles.find(t=>t.id===e)}moveSelected(e){this.selected.forEach(t=>{t.x+=e.x,t.y+=e.y})}resizeSelected(e,t){this.selected.forEach(i=>{i.resize(e,t)})}processDisplacement(){this.selected.forEach(e=>{const{x:t,y:i,width:s,height:c}=e;s<0&&(e.x=t+s,e.width=Math.abs(s)),c<0&&(e.y=i+c,e.height=Math.abs(c)),s<0&&c<0&&(e.x=t+s,e.y=i+c,e.width=Math.abs(s),e.height=Math.abs(c))})}}let E=function(n){return n.AUTO="auto",n.COVER="cover",n.CONTAIN="contain",n}({});var C=function(n){return n.BACKGROUND="background",n.INTERFACE="interface",n}(C||{});const L=E.CONTAIN,T=[C.BACKGROUND,C.INTERFACE],ae={display:"block",width:"100%",height:"100vh",position:"relative"},he={display:"block",position:"absolute",top:0,left:0,width:"100%",height:"100%",backgroundColor:"transparent"},le={size:L,imageSrc:"./test.png",width:800,height:800};function ue({containerElementStyle:n=ae,canvasElementStyle:e=he,background:t=le,zoomExtents:i={min:.33,max:3},geometries:s=[],onViewChange:c}){const r=te(),d=m.useRef(null),h=m.useRef(null),l=m.useRef({}),a=m.useRef({}),g=m.useRef(R()),v=m.useRef(new oe(s));Z({coordinateSystem:g.current,canvas:l.current[C.INTERFACE],context:a.current[C.INTERFACE],rectangles:v.current});function p(o){if(!t)return o;switch(t.size||(t.size=L),t.size){case E.COVER:const w=h.current;if(w){const{width:f,height:S}=w;if(!t.useImageOriginSize){let _=o.width,P=o.height;const k=f/S;return P=_/k,P>o.height&&(P=o.height,_=P*k),{width:_,height:P}}return{width:f,height:S}}return{width:0,height:0};case E.CONTAIN:return{width:t.width||0,height:t.height||0}}return o}function R(){const o=new H(i,r);return o.attachViewChangeListener(u),o}function u({view:o,transform:w}){console.log("applyView",o,w);const f=g.current;f&&(T.map(S=>a.current[S]).forEach(S=>{y(S);const _=f.transformMatrix;S.setTransform(_.a,_.b,_.c,_.d,_.e,_.f)}),D(),j())}function y(o){x([o],()=>o.clearRect(0,0,o.canvas.width,o.canvas.height))}function x(o,w){o.forEach(f=>{f.save(),f.setTransform(b.a,b.b,b.c,b.d,b.e,b.f)});try{w()}finally{o.forEach(f=>f.restore())}}function W(o){g.current.documentSize={...o}}function B({canvas:o,ctx:w,image:f}){if(f&&f.complete&&o&&w&&t)switch(t.size){case E.AUTO:q({canvas:o,ctx:w,image:f});break;case E.COVER:$({ctx:w,image:f});break;case E.CONTAIN:default:J({canvas:o,ctx:w,image:f});break}}function I(o,w=!1){let f=!1;const{canvas:S}=g.current;console.log("handle view change",o,S),(S.width!==o.width||S.height!==o.height)&&(K(l.current,o),W(o),f=!0),(w||f)&&U()}function D(){console.log("update canvas background");const o=l.current[C.BACKGROUND],w=a.current[C.BACKGROUND],f=h.current;!o||!w||(w.clearRect(0,0,o.width,o.height),f&&B({canvas:o,ctx:w,image:f}))}function j(){console.log("re-draw geometries"),y(a.current[C.INTERFACE]),v.current.draw(a.current[C.INTERFACE])}function U(){console.log("redraw all"),D()}return m.useEffect(()=>{console.log("resize container effect",r);const o=p(r);console.log("newSize",o),I(o),typeof c=="function"&&c(o)},[r]),m.useEffect(()=>{if(!(!t||!t.imageSrc||t.imageSrc==="")&&(!h.current||h.current.getAttribute("src")!==t.imageSrc)){console.log("Draw background image",t,h.current);const o=new Image;o.src=t.imageSrc,o.onload=()=>{console.log("load image success");const w=p(r);console.log("load image success newSize",w),I(w,!0)},o.onabort=()=>{h.current=null},h.current=o}},[t,h]),m.useEffect(()=>{console.log("draw rectangles",s),v.current.rectangles=s,v.current.draw(a.current[C.INTERFACE])},[v,s]),z.jsx("div",{style:{...n},ref:d,children:T.map(o=>{const w=o===C.INTERFACE;return z.jsx("canvas",{ref:f=>{f&&(l.current[o]=f,a.current[o]=f.getContext("2d"),w&&(g.current.canvas=f))},style:{...e}},o)})})}function de(){const n={size:E.CONTAIN,width:800,height:800},e=m.useRef(null),[t,i]=m.useState([]),[s,c]=m.useState(n),r=u=>{e.current={...u}},d=u=>{c(y=>({...y,...u}))},h=u=>{const y=u.map(x=>new O(x.id,x.color,x.x,x.y,x.width,x.height));i([...y])},l=u=>{d(u.background),h(u.rectangles),r(u)},a=()=>{const u=new O("newRectangleId",se,0,0,100,100);i(y=>[...y,u])},g=()=>{e.current&&l(e.current)},v=u=>{r({background:s,rectangles:t}),typeof u=="function"&&u(R())},p=()=>t.filter(u=>ce(u)).map(u=>u.exportData()),R=()=>JSON.stringify({background:s,rectangles:t});return{background:s,rectangles:t,loadBackground:d,loadRectangles:h,loadAll:l,addRectangle:a,exportRectangles:p,toString:R,saveData:v,resetData:g}}const ge=[{id:"1",color:"rgba(182, 252, 202, 0.6)",x:70.17637619524753,y:78.01272777881616,width:65.76959920609539,height:93.55788828880145},{id:"2",color:"rgba(124, 31, 155, 0.6)",x:16.86931721082894,y:13.583844432742564,width:48.45572066892827,height:19.708936509030384},{id:"3",color:"rgba(129, 108, 113, 0.6)",x:24.488117224696527,y:28.698217434256932,width:23.61303920407696,height:67.3719030565282}],ve=()=>{const{background:n,rectangles:e,loadBackground:t,saveData:i,addRectangle:s,loadAll:c}=de(),r=a=>{a.preventDefault(),s()},d=a=>{a.preventDefault(),c({background:{color:"rgba(0, 0, 0, 0.5)",image:null},rectangles:ge})},h=a=>{a.preventDefault(),t({imageSrc:"./test.png"})},l=a=>{a.preventDefault(),i(function(g){console.log(g)})};return z.jsxs(G,{children:[z.jsxs("div",{className:"map-tools",children:[z.jsx("button",{onClick:d,children:"load"}),z.jsx("button",{onClick:r,children:"create"}),z.jsx("button",{onClick:h,children:"image"}),z.jsx("button",{onClick:l,children:"save"})]}),z.jsx(ue,{geometries:e,background:n})]})};export{ve as default};
